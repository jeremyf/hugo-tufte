{{- $key := .Get "key"}}
{{- $tag := default "span" (.Get "tag") }}
{{- $itemprop := default "mentions" (.Get "itemprop")}}
{{- $entry := index (where $.Site.Data.glossary "key" "eq" $key) 0 }}
{{- $title := default $entry.title ($entry.mentionAs) }}
{{- $title = default $title ( .Get "title") }}
{{- $name := $title }}
{{- $link := false }}
{{- with (.Get "link") }}
{{ if ne . "t" }}
{{- $link = . }}
{{- else if $entry.sameAs }}
{{- $link = $entry.sameAs }}
{{- else if $entry.itemid }}
{{- $link = $entry.itemid }}
{{- end }}{{- end }}
{{- $scratchKey := printf "abbr-%s" $entry.key }}
{{- if ($.Page.Scratch.Get $scratchKey) }}
{{- if $link }}<a href="{{ $link }}">{{ $name }}</a>{{- else }}{{ $name }}{{- end }}
{{- else }}
{{- $.Page.Scratch.Set $scratchKey "t" }}
{{- if .Get "downcase" }}{{- $name = lower $name}}{{- end }}
{{- if .Get "as" }}{{ $name = .Get "as" }}{{- end }}
{{- $itemtype := default "Thing" ($entry.itemtype) }}
{{- if .Get "abbr" }}{{ $name = default $name ($entry.abbr) }}{{- end }}
{{- printf "<span itemprop=\"%s\" itemscope itemtype=\"http://schema.org/%s\">" $itemprop $itemtype | safeHTML }}{{- if isset $entry "itemid" }}<link itemprop="sameAs" href="{{ $entry.itemid }}" />{{- end }}{{- printf "<%s itemprop=\"name\">" $tag | safeHTML }}{{- if $link }}<a href="{{ $link }}">{{ $name }}</a>{{- else }}{{ $name }}{{- end }}{{- printf "</%s>" $tag | safeHTML }}{{- if ne $name $title }}<meta itemprop="alternateName" content="{{ $title }}">{{- end }}</span>{{- end }}