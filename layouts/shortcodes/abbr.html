{{- define "abbrInner" }}
{{- $title := .data.title }}{{- $text := .text }}{{- if isset .data "abbr" }}{{- $text = .data.abbr }}{{- end }}{{- $scratchKey := printf "abbr-%s" .data.key }}{{- if .Page.Scratch.Get $scratchKey }}<abbr title="{{ $title }}">{{ $text }}</abbr>{{- else }}{{- if isset .data "itemid" }}<span itemprop="mentions" itemscope itemtype="http://schema.org/Thing"><link href="{{ .data.itemid }}" itemprop="sameAs" /><meta content="{{ $title }}" itemprop="name" />{{- end }}<abbr title="{{ $title }}">{{ $text }}</abbr>{{- if not .simple }} <a class="book" rel="tag opener" aria-label="Other site-wide references of “{{ $title }}”" title="Other site-wide references of “{{ $title }}”" href="/site-map/glossary/#abbr-dfn-{{ .data.key }}">&#128214;</a>{{- end }}{{- if isset .data "itemid" }}</span>{{- end }}{{- end }}{{- .Page.Scratch.Set $scratchKey "t" }}{{- end }}{{- $text := .Get 0 }}{{- $key := $text | upper }}{{- $data := index (where $.Site.Data.glossary "key" "eq" $key) 0 }}{{- if not $data }}{{- $singularized := replaceRE "S$" "" $key }}{{- $data = index (where $.Site.Data.glossary "key" "eq" $singularized) 0 }}{{- end }}{{- if $data }}{{- template "abbrInner" (dict "Page" .Page "data" $data "text" $text "simple" (.Get 1) )}}{{- else }}{{- .Get }}{{/* BREAK THE BUILD IF YOU ABBREVIATE WITHOUT ELUCIDATION */}}{{- end }}
